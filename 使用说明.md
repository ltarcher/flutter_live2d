# Flutter Live2D 插件使用说明

## 项目简介

flutter_live2d 是一个 Flutter 插件项目，旨在为 Flutter 应用程序集成 Live2D 角色模型展示与交互能力。该插件基于 Cubism SDK 实现，支持在移动平台上渲染和控制 Live2D 模型。

## 工作原理

### 整体架构

```
Dart (Flutter App)
    ↓ MethodChannel
Platform Interface (flutter_live2d_platform_interface.dart)
    ↙                    ↘
Android (Kotlin + CubismSdkForJava)    Web (stub 实现)
```

### 核心组件

1. **Flutter 层**
   - [flutter_live2d.dart](file:///d:/develop/AI/xiaozhi/flutter_live2d/lib/flutter_live2d.dart) - 主要API接口
   - [flutter_live2d_platform_interface.dart](file:///d:/develop/AI/xiaozhi/flutter_live2d/lib/flutter_live2d_platform_interface.dart) - 平台抽象接口
   - [flutter_live2d_method_channel.dart](file:///d:/develop/AI/xiaozhi/flutter_live2d/lib/flutter_live2d_method_channel.dart) - 方法通道实现

2. **Android 原生层**
   - [FlutterLive2dPlugin.kt](file:///d:/develop/AI/xiaozhi/flutter_live2d/android/src/main/kotlin/com/plugin/flutter_live2d/FlutterLive2dPlugin.kt) - Flutter插件主类
   - [Live2DView.kt](file:///d:/develop/AI/xiaozhi/flutter_live2d/android/src/main/kotlin/com/plugin/flutter_live2d/Live2DView.kt) - OpenGL视图渲染器
   - [Live2DModel.kt](file:///d:/develop/AI/xiaozhi/flutter_live2d/android/src/main/kotlin/com/plugin/flutter_live2d/Live2DModel.kt) - 模型管理器

### 工作流程

1. Flutter 应用通过 [FlutterLive2d](file:///d:/develop/AI/xiaozhi/flutter_live2d/lib/flutter_live2d.dart#L3-L26) 类调用相关方法
2. 调用通过 MethodChannel 传递到原生平台
3. Android 端的 [FlutterLive2dPlugin](file:///d:/develop/AI/xiaozhi/flutter_live2d/android/src/main/kotlin/com/plugin/flutter_live2d/FlutterLive2dPlugin.kt#L12-L96) 接收并处理请求
4. [Live2DView](file:///d:/develop/AI/xiaozhi/flutter_live2d/android/src/main/kotlin/com/plugin/flutter_live2d/Live2DView.kt#L15-L159) 负责渲染模型
5. [Live2DModel](file:///d:/develop/AI/xiaozhi/flutter_live2d/android/src/main/kotlin/com/plugin/flutter_live2d/Live2DModel.kt#L11-L177) 管理模型数据、动作和表情

## 集成方式

### 方式一：通过 Pub 包管理器集成（推荐）

这是标准的 Flutter 插件使用方式，适用于生产环境：

1. 在目标项目的 [pubspec.yaml](file:///d:/develop/AI/xiaozhi/flutter_live2d/example/pubspec.yaml) 中添加依赖：

```yaml
dependencies:
  flutter_live2d: ^0.0.1
```

2. 运行 `flutter pub get` 获取依赖

### 方式二：本地集成插件源代码

如果您希望直接使用插件源代码或将插件集成到私有项目中，请按以下步骤操作：

1. 将整个 `flutter_live2d` 目录复制到您的 Flutter 项目根目录下：

```
your_flutter_project/
├── lib/
├── assets/
├── flutter_live2d/        <- 将插件目录复制到这里
│   ├── lib/
│   ├── android/
│   ├── ios/
│   ├── pubspec.yaml
│   └── ...
└── pubspec.yaml          <- 修改这个文件
```

2. 修改目标项目的 [pubspec.yaml](file:///d:/develop/AI/xiaozhi/flutter_live2d/example/pubspec.yaml)，添加对本地插件的引用：

```yaml
dependencies:
  flutter:
    sdk: flutter
  
  # 添加这一行来引用本地插件
  flutter_live2d:
    path: ./flutter_live2d    # 插件相对于当前 pubspec.yaml 的路径
```

3. 复制模型资源文件到您的项目中：

将示例中的模型资源文件复制到您的项目中：

```
your_flutter_project/
├── assets/
│   └── live2d/             <- 复制整个 live2d 文件夹到这里
│       ├── Haru/
│       ├── Hiyori/
│       └── ...
└── pubspec.yaml
```

并在 `pubspec.yaml` 中声明这些资源：

```yaml
flutter:
  assets:
    - assets/live2d/
    - assets/live2d/Haru/
    - assets/live2d/Haru/Haru.model3.json
    - assets/live2d/Haru/Haru.physics3.json
    - assets/live2d/Haru/Haru.2048/
    - assets/live2d/Haru/motions/
    - assets/live2d/Haru/expressions/
    - assets/live2d/Haru/sounds/
    # 根据需要添加更多模型文件
```

## 使用方法

### 1. 初始化插件

在使用前需要初始化插件：

```dart
import 'package:flutter_live2d/flutter_live2d.dart';

await FlutterLive2d.initLive2d();
```

### 2. 加载模型

使用模型路径加载指定的 Live2D 模型：

```dart
await FlutterLive2d.loadModel("assets/live2d/Haru/Haru.model3.json");
```

### 3. 显示模型视图

在界面中使用 AndroidView 显示 Live2D 模型：

```dart
AndroidView(
  viewType: 'live2d_view',
  creationParams: <String, dynamic>{},
  creationParamsCodec: const StandardMessageCodec(),
)
```

### 4. 控制模型

可以使用以下方法控制模型：

```dart
// 设置缩放
FlutterLive2d.setScale(1.5);

// 设置位置
FlutterLive2d.setPosition(100.0, 200.0);

// 播放动作
FlutterLive2d.startMotion("idle", 0);

// 设置表情
FlutterLive2d.setExpression("smile");
```

## 使用示例

完整的使用示例如下：

```dart
import 'package:flutter/material.dart';
import 'package:flutter/services.dart';
import 'package:flutter_live2d/flutter_live2d.dart';

class Live2DDemo extends StatefulWidget {
  @override
  _Live2DDemoState createState() => _Live2DDemoState();
}

class _Live2DDemoState extends State<Live2DDemo> {
  @override
  void initState() {
    super.initState();
    WidgetsBinding.instance.addPostFrameCallback((_) {
      _initLive2D();
    });
  }

  Future<void> _initLive2D() async {
    try {
      await FlutterLive2d.initLive2d();
      await Future.delayed(Duration(milliseconds: 500));
      await FlutterLive2d.loadModel("assets/live2d/Haru/Haru.model3.json");
    } catch (e) {
      print("初始化失败: $e");
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(title: Text('Live2D Demo')),
      body: Stack(
        children: [
          // Live2D视图
          Center(
            child: Container(
              width: MediaQuery.of(context).size.width,
              height: MediaQuery.of(context).size.height * 0.8,
              color: Colors.grey[200],
              child: AndroidView(
                viewType: 'live2d_view',
                creationParams: <String, dynamic>{},
                creationParamsCodec: const StandardMessageCodec(),
              ),
            ),
          ),

          // 控制按钮
          Positioned(
            bottom: 20,
            left: 0,
            right: 0,
            child: Row(
              mainAxisAlignment: MainAxisAlignment.spaceEvenly,
              children: [
                ElevatedButton(
                  onPressed: () => FlutterLive2d.startMotion("idle", 0),
                  child: Text('待机动作'),
                ),
                ElevatedButton(
                  onPressed: () => FlutterLive2d.setExpression("smile"),
                  child: Text('微笑表情'),
                ),
                ElevatedButton(
                  onPressed: () => FlutterLive2d.setScale(1.5),
                  child: Text('放大'),
                ),
                ElevatedButton(
                  onPressed: () => FlutterLive2d.setScale(1.0),
                  child: Text('还原'),
                ),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
```

## 注意事项

1. 当前版本仅支持 Android 平台，iOS 和 Web 平台尚未完整实现
2. 模型文件必须是 Live2D Cubism 3.0 或更高版本格式（.model3.json）
3. 模型相关的纹理、动作、表情等文件必须一并打包
4. 不应将插件代码直接放入 Flutter SDK 目录，而应在项目级别进行集成